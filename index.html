<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-g" />
    <link rel="icon" type="image/svg+xml" href="./vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Capacity Tracker MVP</title>
    <!-- Add Babel Standalone for in-browser transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'brand-primary': '#1e40af', // blue-800
              'brand-secondary': '#3b82f6', // blue-500
              'brand-accent': '#10b981', // emerald-500
              'brand-danger': '#ef4444', // red-500
              'brand-light': '#f1f5f9', // slate-100
              'brand-dark': '#1e293b', // slate-800
            },
          }
        }
      }
    </script>
  <script type="importmap">
{
  "imports": {
    "react-router-dom": "https://aistudiocdn.com/react-router-dom@^7.9.4",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "recharts": "https://aistudiocdn.com/recharts@^3.3.0"
  }
}
</script>
</head>
  <body class="bg-brand-light dark:bg-brand-dark">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// All library imports are handled by the importmap
import React, { useState, useEffect, useCallback } from 'react';
import ReactDOM from 'react-dom/client';
import { HashRouter, Routes, Route, useParams, useNavigate, useLocation } from 'react-router-dom';
import { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer } from 'recharts';

// --- START: Inlined File: types.ts ---

// Note: No 'export' needed as these are now in the same script scope.
interface CapacityState {
  energy: number;
  attention: number;
  physical: number;
}

type CheckInType = 'normal' | 'increase' | 'drop';

interface CheckIn {
  id: string;
  timestamp: number;
  capacity: CapacityState;
  journal: string;
  overallCapacity: number;
  type: CheckInType;
}

// --- END: Inlined File: types.ts ---


// --- START: Inlined File: hooks/useUserData.ts ---

const calculateOverallCapacity = (capacity: CapacityState): number => {
  const { energy, attention, physical } = capacity;
  // All three values are on a 0-12 scale where 12 is optimal.
  return (energy + attention + physical) / 3;
};

const determineCheckInType = (current: number, previous: number | null): CheckInType => {
  if (previous === null) return 'normal';
  const diff = current - previous;
  if (diff > 0.5) return 'increase'; // A noticeable recovery
  if (diff < -2.0) return 'drop'; // A sudden drop
  return 'normal';
};

const useUserData = (userId: string) => {
  const [checkIns, setCheckIns] = useState<CheckIn[]>([]);
  const [loading, setLoading] = useState(true);

  const getStorageKey = useCallback(() => `capacity-tracker-data-${userId}`, [userId]);

  useEffect(() => {
    try {
      const storedData = localStorage.getItem(getStorageKey());
      if (storedData) {
        const parsedData: CheckIn[] = JSON.parse(storedData);
        // Filter for today's check-ins
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todaysCheckins = parsedData.filter(c => new Date(c.timestamp) >= today);
        setCheckIns(todaysCheckins.sort((a, b) => a.timestamp - b.timestamp));
      }
    } catch (error) {
      console.error("Failed to load user data from localStorage", error);
    } finally {
      setLoading(false);
    }
  }, [userId, getStorageKey]);

  useEffect(() => {
    try {
      if (!loading) {
        // Ensure check-ins are sorted before saving
        const sortedCheckIns = [...checkIns].sort((a, b) => a.timestamp - b.timestamp);
        localStorage.setItem(getStorageKey(), JSON.stringify(sortedCheckIns));
      }
    } catch (error) {
      console.error("Failed to save user data to localStorage", error);
    }
  }, [checkIns, loading, getStorageKey]);

  const addCheckIn = useCallback((capacity: CapacityState, journal: string, timestamp: number) => {
    const overallCapacity = calculateOverallCapacity(capacity);
    
    const sortedCheckIns = [...checkIns].sort((a, b) => a.timestamp - b.timestamp);
    const lastCheckIn = sortedCheckIns.filter(c => c.timestamp < timestamp).pop() || null;

    const type = determineCheckInType(overallCapacity, lastCheckIn?.overallCapacity ?? null);

    const newCheckIn: CheckIn = {
      id: `checkin-${timestamp}-${Math.random()}`,
      timestamp,
      capacity,
      journal,
      overallCapacity,
      type,
    };

    setCheckIns(prev => [...prev, newCheckIn].sort((a, b) => a.timestamp - b.timestamp));
  }, [checkIns]);

  return { checkIns, addCheckIn, loading };
};

// --- END: Inlined File: hooks/useUserData.ts ---


// --- START: Inlined File: components/Header.tsx ---

const Header: React.FC<{ userId: string; onLogout: () => void; }> = ({ userId, onLogout }) => {
  return (
    <header className="sticky top-0 z-10 p-4 bg-white shadow-md">
      <div className="container flex items-center justify-between mx-auto">
        <h1 className="text-xl font-bold text-brand-dark md:text-2xl">
          Capacity Tracker
        </h1>
        <div className="flex items-center space-x-4">
          <span className="hidden text-sm text-slate-500 sm:block">User: {userId}</span>
          <button
            onClick={onLogout}
            className="px-3 py-2 text-sm font-medium text-white transition-colors duration-200 rounded-md bg-brand-secondary hover:bg-brand-primary"
          >
            Log Out
          </button>
        </div>
      </div>
    </header>
  );
};

// --- END: Inlined File: components/Header.tsx ---


// --- START: Inlined File: components/CheckInForm.tsx ---

const CapacitySlider: React.FC<{
  label: string;
  value: number;
  onChange: (value: number) => void;
  inverted?: boolean;
}> = ({ label, value, onChange, inverted = false }) => {
  
  const sliderValue = inverted ? 12 - value : value;

  const handleChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const newSliderValue = parseInt(e.target.value, 10);
    onChange(inverted ? 12 - newSliderValue : newSliderValue);
  };

  return (
    <div>
        <label className="block mb-2 text-sm font-medium text-slate-700">{label}: <span className="font-bold text-brand-primary">{value}</span></label>
        <div className="flex items-center w-full space-x-3">
            <span className="text-xs text-slate-500">Full</span>
            <input
                type="range"
                min="0"
                max="12"
                step="1"
                value={sliderValue}
                onChange={handleChange}
                className="w-full h-2 rounded-lg appearance-none cursor-pointer bg-slate-200"
            />
            <span className="text-xs text-slate-500">Empty</span>
        </div>
    </div>
  );
};

const CheckInForm: React.FC<{
  onSubmit: (capacity: CapacityState, journal: string, timestamp: number) => void;
  lastCheckIn: CheckIn | null;
  isFirstCheckIn: boolean;
}> = ({ onSubmit, lastCheckIn, isFirstCheckIn }) => {
  const [capacity, setCapacity] = useState<CapacityState>({ energy: 8, attention: 8, physical: 8 });
  const [journal, setJournal] = useState('');
  const [isJournaling, setIsJournaling] = useState(false);
  const [time, setTime] = useState(new Date().toTimeString().substring(0, 5));
  const [isEditingTime, setIsEditingTime] = useState(false);


  useEffect(() => {
      if (isFirstCheckIn) {
          setCapacity({ energy: 12, attention: 12, physical: 12 });
      } else if (lastCheckIn) {
          setCapacity(lastCheckIn.capacity);
      }
  }, [lastCheckIn, isFirstCheckIn]);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    const [hours, minutes] = time.split(':').map(Number);
    const checkInDate = new Date();
    checkInDate.setHours(hours, minutes, 0, 0);
    const timestamp = checkInDate.getTime();

    onSubmit(capacity, journal, timestamp);
    setJournal('');
    setIsJournaling(false);
  };

  const handleCapacityChange = (field: keyof CapacityState, value: number) => {
    setCapacity(prev => ({ ...prev, [field]: value }));
  };

  return (
    <div className="p-6 bg-white rounded-lg shadow-md">
       <div className="flex items-start justify-between mb-4">
        <h2 className="text-xl font-semibold text-brand-dark">
          {isFirstCheckIn ? "Check-in Today" : "New Check-In"}
        </h2>
        <div className="text-sm">
          {!isEditingTime ? (
            <button
              type="button"
              onClick={() => setIsEditingTime(true)}
              className="flex items-center px-2 py-1 transition-colors rounded-md text-slate-600 hover:bg-slate-100"
              title="Change check-in time"
            >
              <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
              {time}
            </button>
          ) : (
            <div className="flex items-center space-x-2">
              <input
                type="time"
                id="checkin-time"
                value={time}
                onChange={(e) => setTime(e.target.value)}
                className="w-24 p-1 text-sm border rounded-md border-slate-300 focus:ring-brand-secondary focus:border-brand-secondary"
              />
              <button
                type="button"
                onClick={() => setIsEditingTime(false)}
                className="px-2 py-1 text-xs font-semibold text-white transition-colors rounded-md bg-brand-secondary hover:bg-brand-primary"
              >
                Set
              </button>
            </div>
          )}
        </div>
      </div>
      <form onSubmit={handleSubmit} className="space-y-6">
        <div className="p-4 space-y-6 border rounded-lg border-slate-200">
            <CapacitySlider label="Energy" value={capacity.energy} onChange={(v) => handleCapacityChange('energy', v)} inverted />
            <CapacitySlider label="Attention" value={capacity.attention} onChange={(v) => handleCapacityChange('attention', v)} inverted />
            <CapacitySlider label="Physical" value={capacity.physical} onChange={(v) => handleCapacityChange('physical', v)} inverted />
        </div>
        
        <div>
          {!isJournaling ? (
            <button
              type="button"
              onClick={() => setIsJournaling(true)}
              className="w-full p-2 text-sm transition-colors rounded-md text-brand-secondary hover:bg-slate-100"
            >
              Do you want to journal about how you feel?
            </button>
          ) : (
            <div>
              <label htmlFor="journal" className="block mb-2 text-sm font-medium text-slate-700">Journal</label>
              <textarea
                id="journal"
                value={journal}
                onChange={(e) => setJournal(e.target.value)}
                placeholder="What drained or recharged you?"
                className="w-full p-2 border rounded-md border-slate-300 focus:ring-brand-secondary focus:border-brand-secondary"
                rows={3}
              ></textarea>
              <div className="flex justify-end mt-2">
                 <button
                    type="button"
                    disabled
                    title="AI analysis coming soon!"
                    className="px-3 py-1 text-xs font-semibold text-white transition-colors duration-200 rounded-md bg-slate-400 cursor-not-allowed"
                >
                    GPT Review
                </button>
              </div>
            </div>
          )}
        </div>
        <button
          type="submit"
          className="w-full px-4 py-2 font-bold text-white transition-colors duration-200 rounded-md bg-brand-primary hover:bg-brand-secondary"
        >
          Log Capacity
        </button>
      </form>
    </div>
  );
};

// --- END: Inlined File: components/CheckInForm.tsx ---


// --- START: Inlined File: components/CapacityChart.tsx ---

const CustomDot: React.FC<any> = (props) => {
    const { cx, cy, payload } = props;
    
    if (payload.overallCapacity === null || payload.overallCapacity === undefined) {
        return null;
    }

    let color = '#334155'; // slate-700 (normal)
    if (payload.type === 'increase') {
        color = '#10b981'; // emerald-500 (green)
    } else if (payload.type === 'drop') {
        color = '#3b82f6'; // blue-500 (blue)
    }

    return (
        <svg x={cx - 5} y={cy - 5} width="10" height="10" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="5" cy="5" r="5" fill={color}/>
        </svg>
    );
};

const CustomTooltip: React.FC<any> = ({ active, payload, label }) => {
    if (active && payload && payload.length) {
        const data = payload[0].payload;
        if (data.overallCapacity === null || data.overallCapacity === undefined) {
            return null;
        }
        return (
            <div className="p-3 bg-white border rounded-md shadow-lg border-slate-200">
                <p className="font-bold text-slate-700">{`Time: ${label}`}</p>
                <p className="text-brand-primary">{`Your Capacity: ${data.overallCapacity.toFixed(2)}`}</p>
                <p className="text-slate-500">{`Expected: ${data.expected.toFixed(2)}`}</p>
                <p className="text-sm text-slate-500">{`E: ${data.capacity.energy}, A: ${data.capacity.attention}, P: ${data.capacity.physical}`}</p>
                {data.journal && <p className="mt-2 text-xs italic text-slate-600">"{data.journal}"</p>}
            </div>
        );
    }
    return null;
};

const CapacityChart: React.FC<{ data: CheckIn[]; }> = ({ data }) => {
  const today = new Date();
  today.setHours(8, 0, 0, 0);
  const eightAmTimestamp = today.getTime();

  const hourlyExpectedData = Array.from({ length: 13 }, (_, i) => {
      const timestamp = eightAmTimestamp + i * 60 * 60 * 1000;
      return {
          timestamp,
          time: new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
          overallCapacity: null,
          expected: 12 - i,
      };
  });

  const formattedUserData = data.map(item => {
    const hoursSince8Am = (item.timestamp - eightAmTimestamp) / (1000 * 60 * 60);
    return {
      ...item,
      time: new Date(item.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
      expected: Math.max(0, 12 - hoursSince8Am),
    };
  });

  const combinedDataMap = new Map();
  [...hourlyExpectedData, ...formattedUserData].forEach(item => {
      combinedDataMap.set(item.time, { ...combinedDataMap.get(item.time), ...item });
  });
  const chartData = Array.from(combinedDataMap.values()).sort((a,b) => a.timestamp - b.timestamp);
  
  return (
    <div className="p-4 bg-white rounded-lg shadow-md min-h-96">
      <h2 className="mb-4 text-xl font-semibold text-brand-dark">Daily Capacity Timeline</h2>
      {data.length > 0 ? (
      <ResponsiveContainer width="100%" height={350}>
        <LineChart data={chartData} margin={{ top: 5, right: 20, left: -10, bottom: 20 }}>
          <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" />
          <XAxis dataKey="time" tick={{ fill: '#64748b' }} />
          <YAxis domain={[0, 12]} tick={{ fill: '#64748b' }} />
          <Tooltip content={<CustomTooltip />}/>
          <Legend />
          <Line 
            type="monotone" 
            dataKey="overallCapacity" 
            name="Your Capacity"
            stroke="#1e40af" 
            strokeWidth={2}
            dot={<CustomDot />}
            activeDot={{ r: 8, stroke: '#60a5fa' }} 
            connectNulls
            />
          <Line 
            type="monotone"
            dataKey="expected"
            name="Expected Path"
            stroke="#94a3b8"
            strokeDasharray="5 5"
            dot={false}
            activeDot={false}
            />
        </LineChart>
      </ResponsiveContainer>
      ) : (
        <div className="flex items-center justify-center h-full text-slate-500">
            <p>No check-ins yet for today. Add one to see your timeline!</p>
        </div>
      )}
    </div>
  );
};

// --- END: Inlined File: components/CapacityChart.tsx ---


// --- START: Inlined File: components/LogList.tsx ---

const LogItem: React.FC<{ checkIn: CheckIn }> = ({ checkIn }) => {
  const { timestamp, capacity, journal, overallCapacity, type } = checkIn;
  const time = new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

  const typeStyles = {
    normal: { icon: '●', color: 'text-slate-500' },
    increase: { icon: '▲', color: 'text-emerald-500' },
    drop: { icon: '▼', color: 'text-blue-500' },
  };

  const { icon, color } = typeStyles[type];

  return (
    <li className="flex flex-col p-4 space-y-2 border-b sm:flex-row sm:justify-between sm:items-start border-slate-200">
      <div className="flex items-start">
        <span className={`text-2xl mr-3 ${color}`} title={`Type: ${type}`}>{icon}</span>
        <div>
          <p className="font-semibold text-slate-800">{time}</p>
          <p className="text-sm text-slate-600">
            Capacity: <span className="font-bold text-brand-primary">{overallCapacity.toFixed(1)}</span>
            <span className="ml-4 text-xs text-slate-500">(E: {capacity.energy}, A: {capacity.attention}, P: {capacity.physical})</span>
          </p>
        </div>
      </div>
      {journal && (
        <p className="pt-1 pl-8 text-sm italic text-slate-700 sm:pl-0 sm:pt-0 sm:max-w-xs md:max-w-sm lg:max-w-md">
          "{journal}"
        </p>
      )}
    </li>
  );
};

const LogList: React.FC<{ checkIns: CheckIn[] }> = ({ checkIns }) => {
  const reversedCheckIns = [...checkIns].reverse();

  return (
    <div className="bg-white rounded-lg shadow-md">
      <h2 className="p-4 text-xl font-semibold border-b text-brand-dark border-slate-200">Today's Log</h2>
      {reversedCheckIns.length > 0 ? (
        <ul>
          {reversedCheckIns.map(checkIn => (
            <LogItem key={checkIn.id} checkIn={checkIn} />
          ))}
        </ul>
      ) : (
        <p className="p-4 text-slate-500">No entries logged yet today.</p>
      )}
    </div>
  );
};

// --- END: Inlined File: components/LogList.tsx ---


// --- START: Inlined File: pages/LoginPage.tsx ---

const LoginPage: React.FC = () => {
  const [key, setKey] = useState('');
  const navigate = useNavigate();

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (key.match(/^0x[a-fA-F0-9]+$/)) {
      localStorage.setItem('capacity-tracker-key', key);
      navigate(`/user/${key}`);
    } else {
      alert('Please enter a valid hex key (e.g., 0xA1B2C3).');
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-slate-100">
      <div className="w-full max-w-md p-8 space-y-8 bg-white rounded-2xl shadow-lg">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-brand-dark">Capacity Tracker</h1>
          <p className="mt-2 text-slate-600">Enter your unique key to access your daily log.</p>
        </div>
        <form className="mt-8 space-y-6" onSubmit={handleSubmit}>
          <div>
            <label htmlFor="key-input" className="sr-only">
              Access Key
            </label>
            <input
              id="key-input"
              name="key"
              type="text"
              required
              className="relative block w-full px-3 py-3 text-lg placeholder-slate-500 border rounded-md appearance-none border-slate-300 focus:outline-none focus:ring-brand-secondary focus:border-brand-secondary focus:z-10"
              placeholder="e.g., 0xA1B2C3"
              value={key}
              onChange={(e) => setKey(e.target.value)}
            />
          </div>
          <button
            type="submit"
            className="relative flex justify-center w-full px-4 py-3 text-lg font-medium text-white border border-transparent rounded-md group bg-brand-primary hover:bg-brand-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-brand-primary"
          >
            Unlock Dashboard
          </button>
        </form>
         <p className="mt-4 text-xs text-center text-slate-500">
          This is a prototype. Your key is stored only in your browser's local storage for convenience.
        </p>
      </div>
    </div>
  );
};

// --- END: Inlined File: pages/LoginPage.tsx ---


// --- START: Inlined File: pages/DashboardPage.tsx ---

const DashboardPage: React.FC<{ userId: string; }> = ({ userId }) => {
  const { checkIns, addCheckIn, loading } = useUserData(userId);
  const navigate = useNavigate();
  const [activeTab, setActiveTab] = useState('checkin');

  const handleLogout = () => {
    localStorage.removeItem('capacity-tracker-key');
    navigate('/');
  };

  const handleAddCheckIn = (capacity: CapacityState, journal: string, timestamp: number) => {
    addCheckIn(capacity, journal, timestamp);
  };

  if (loading) {
    return <div className="flex items-center justify-center min-h-screen">Loading...</div>;
  }

  const isFirstCheckIn = checkIns.length === 0;

  return (
    <div className="min-h-screen bg-slate-100">
      <Header userId={userId} onLogout={handleLogout} />
      <main className="container p-4 mx-auto md:p-6">
        <div className="mb-6 border-b border-slate-300">
          <nav className="flex -mb-px space-x-6" aria-label="Tabs">
            <button
              onClick={() => setActiveTab('checkin')}
              className={`${
                activeTab === 'checkin'
                  ? 'border-brand-primary text-brand-primary'
                  : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
              } whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              Check-In & Log
            </button>
            <button
              onClick={() => setActiveTab('timeline')}
              className={`${
                activeTab === 'timeline'
                  ? 'border-brand-primary text-brand-primary'
                  : 'border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300'
              } whitespace-nowrap py-4 px-1 border-b-2 font-medium text-lg focus:outline-none`}
            >
              Daily Timeline
            </button>
          </nav>
        </div>

        <div>
          {activeTab === 'checkin' && (
            <div className="space-y-6">
              <CheckInForm
                onSubmit={handleAddCheckIn}
                lastCheckIn={checkIns[checkIns.length - 1] || null}
                isFirstCheckIn={isFirstCheckIn}
              />
              <LogList checkIns={checkIns} />
            </div>
          )}
          {activeTab === 'timeline' && (
             <CapacityChart data={checkIns} />
          )}
        </div>
      </main>
    </div>
  );
};

// --- END: Inlined File: pages/DashboardPage.tsx ---


// --- START: Inlined File: App.tsx ---

const App: React.FC = () => {
  return (
    <div className="min-h-screen bg-slate-50 text-slate-800">
      <HashRouter>
        <AppContent />
      </HashRouter>
    </div>
  );
};

const AppContent: React.FC = () => {
  const [userId, setUserId] = useState<string | null>(null);
  const location = useLocation();
  const navigate = useNavigate();

  useEffect(() => {
    const hash = location.hash;
    const match = hash.match(/^#\/user\/(0x[a-fA-F0-9]+)$/);
    if (match && match[1]) {
      const key = match[1];
      setUserId(key);
      localStorage.setItem('capacity-tracker-key', key);
    } else {
      const storedKey = localStorage.getItem('capacity-tracker-key');
      if (storedKey) {
        navigate(`/user/${storedKey}`);
      } else {
        setUserId(null);
        if (location.pathname !== "/") {
           navigate('/');
        }
      }
    }
  }, [location, navigate]);

  return (
    <Routes>
      <Route path="/user/:userId" element={<DashboardPageWrapper />} />
      <Route path="/" element={<LoginPage />} />
    </Routes>
  );
};

const DashboardPageWrapper: React.FC = () => {
  const { userId } = useParams<{ userId: string }>();
  if (!userId) {
    return <LoginPage />;
  }
  return <DashboardPage userId={userId} />;
};

// --- END: Inlined File: App.tsx ---


// --- START: Inlined File: index.tsx ---

const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}

const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <App />
  </React.StrictMode>
);

// --- END: Inlined File: index.tsx ---

    </script>
  </body>
</html>
